"""
This module contains utilities to work with code generated by prost-build.
"""

load("@rules_rust//rust:defs.bzl", "rust_binary", "rust_test")

def generated_files_check(name, srcs, deps, data, manifest_dir):
    rust_test(
        name = name,
        srcs = srcs,
        data = data + [
            "@rules_rust//rust/toolchain:current_exec_rustfmt_files",
            "@com_google_protobuf//:protoc",
            "@com_google_protobuf//:well_known_protos",
        ],
        edition = "2018",
        env = {
            "PROTOC": "$(rootpath @com_google_protobuf//:protoc)",
            "PROTOC_INCLUDE": "external/com_github_protocolbuffers_protobuf/src",
            "CARGO_MANIFEST_DIR": manifest_dir,
        },
        deps = deps,
    )

def protobuf_generator(name, srcs, deps = [], data = []):
    rust_binary(
        name = name,
        srcs = srcs,
        data = data + [
            "@com_google_protobuf//:protoc",
            "@com_google_protobuf//:well_known_protos",
            "@rules_rust//rust/toolchain:current_exec_rustfmt_files",
        ],
        edition = "2018",
        rustc_env = {
            "PROTOC": "$(rootpath @com_google_protobuf//:protoc)",
            "PROTOC_INCLUDE": "external/com_github_protocolbuffers_protobuf/src",
        },
        deps = deps,
    )
